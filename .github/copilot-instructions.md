<!-- Autogenerated guidance for AI coding agents working on L-Slash -->
# L-Slash — Copilot Instructions

Short, actionable guidance for editing and extending this Rust codebase.

- **Big picture**: This repo is an Axum-based URL/record service with two entry points:
  - HTTP server: `src/main.rs` (default run). Builds an `AppState` with a `SledStore` and starts Axum on port `8090`.
  - CLI: `src/cli/main.rs` (binary `cli`) for offline/store operations (add/list/lookup/move records).

- **Major components & boundaries**:
  - `src/web/` — HTTP routing, handlers, and middleware. See `src/web/routes.rs` and `src/web/handlers/*.rs`.
  - `src/services/` — domain logic: `user`, `auth`, `url`, `result`.
  - `src/storage/` — persistence layer. `sled_store.rs` wraps `sled` with `SledTree<T>` that stores Protobuf messages as bytes.
  - `src/app.rs` / `src/lib.rs` — app wiring and `include!(concat!(env!("OUT_DIR"), "/protobuf_generated/generated.rs"))` for generated Protobuf types.

- **Data flow highlights**:
  - All domain types (`User`, `Session`, `Record`) are Protobuf messages (generated at build time).
  - `SledTree<D: DataType>` serializes/deserializes protobuf bytes for persistence. Use `SledTree::look_up`, `insert`, `range`, `remove`.
  - Session cookie format: `base64(key)/base64(secret)` (see `src/services/auth.rs` helpers `encode_cookie_str` / `decode_cookie_str`).
  - Session rotation is handled in `services::auth` — if rotation occurs, middleware expects a new cookie value and handlers set it using `web::util::see_other_with_cookie`.

- **Build & run (practical)**:
  - Normal dev server: `cargo run` (runs `l_slash` per `Cargo.toml` `default-run`).
  - Release server (enables secure cookie flag): `cargo run --release`.
  - CLI: `cargo run --bin cli -- <action>` or run built binary in `target/debug/cli`.
  - Proto generation: handled by `build.rs` and `protobuf-codegen` build-dependencies — a normal `cargo build` will generate protobuf sources into `OUT_DIR` used via `include!`.

- **Project-specific conventions** (do not break these without cross-checking):
  - Protobuf-first domain types: add/modify `.proto` sources (if present) and rely on the `build.rs` generator. The repo stores generated outputs under `target/` during builds.
  - DB location: default sled DB path is `sled_data` (see `main.rs` and `SledStore::new`). Local development often reuses this folder.
  - Cookie security toggles by build profile: code sets `cookie_secure = !cfg!(debug_assertions)` in `main.rs`.
  - Error types: storage errors use `storage::DataStoreError` (thiserror) — follow existing error wrappers.

- **Patterns & examples**:
  - Middleware with state: routes use `axum::middleware::from_fn_with_state(state.clone(), auth_cookie::auth_cookie_middleware)` in `src/web/routes.rs`.
  - Returning a redirect + cookie: use `web::util::see_other_with_cookie(target, cookie, secure, jar)` (see `src/web/handlers/http.rs`).
  - Generic store helpers: `SledTree<D>` enforces `D: ::protobuf::Message` — prefer using the provided wrapper rather than raw sled operations.

- **Where to change behavior safely**:
  - Add routes/handlers: `src/web/routes.rs` + `src/web/handlers/*.rs`.
  - Session / auth logic: `src/services/auth.rs` (cookie format, rotation, validation).
  - Storage schema and logic: `src/storage/sled_store.rs` and `src/services/*` (use protobuf types when serializing).

- **Quick checks before PRs**:
  - Run `cargo build` to ensure protobuf codegen runs and there are no missing generated symbols.
  - Verify `sled_data/` permissions and consider using a different path locally (CLI supports `--db-path` flags via `src/cli/flags.rs`).
  - If touching session/cookie logic, test both debug and release runs (cookie `secure` behavior differs).

If anything here is unclear or you'd like the file to include more examples (e.g., common diffs, test patterns, or a checklist for PR reviewers), tell me which areas to expand and I will iterate.
